# SITP German AI Agent 后端数据库开发说明（精简版）

## 1) 当前数据库设计（已实现）

数据库：PostgreSQL（当前开发环境通过Docker运行）

表（10 张）：

- `users`
- `classes`
- `students`
- `student_abilities`
- `homeworks`
- `homework_reviews`
- `scenarios`
- `scenario_pushes`
- `exams`
- `exam_assignments`

代码分层：

- 连接： [backend/db/session.py](backend/db/session.py)
- ORM： [backend/models/entities.py](backend/models/entities.py)
- Schema： [backend/schemas/entities.py](backend/schemas/entities.py)
- CRUD： [backend/crud/repositories.py](backend/crud/repositories.py)

---

## 2) 数据库接口（当前后端已接通）

教师端 8 个：

1. `POST /api/auth/login`
2. `GET /api/teacher/dashboard`
3. `POST /api/scenario/publish`
4. `POST /api/exam/generate`
5. `GET /api/student/detail?id=...`
6. `GET /api/homework/detail?id=...`
7. `POST /api/homework/save`
8. `POST /api/student/push-scheme`

路由实现位置： [backend/main.py](backend/main.py)

说明：当前只是打通“接口链路”（路由 → CRUD → DB），仅用于联调与验收；后续可按需进行复杂业务开发。

---

## 3) 后端开发时的具体使用方法

### 3.1 打开docker-desktop并启动 PG 容器

先打开docker-desktop，确保running

```powershell
docker start sitp-pg
```

首次创建：

```powershell
docker run --name sitp-pg -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=sitp_german_ai_agent -p 5432:5432 -d postgres:16
```

### 3.2 建库/导入结构与数据

在项目根目录执行：

```powershell
docker cp .\backend\db\sql\001_init_schema.sql sitp-pg:/tmp/001_init_schema.sql
docker cp .\backend\db\sql\002_seed_demo.sql sitp-pg:/tmp/002_seed_demo.sql
docker exec -i sitp-pg psql -U postgres -d sitp_german_ai_agent -f /tmp/001_init_schema.sql
docker exec -i sitp-pg psql -U postgres -d sitp_german_ai_agent -f /tmp/002_seed_demo.sql
```

### 3.3 配置后端环境变量

编辑 [backend/.env](backend/.env) 加入：

```env
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/sitp_german_ai_agent
```

### 3.4 启动后端

在项目根目录执行：

```powershell
Set-Location .\backend
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 3.5 验证

打开 `http://localhost:8000/docs`，测试上述 8 个接口。

---

## 4) 建议开发联调用SQL脚本

### 4.1 注意

- `init_db.py`（`Base.metadata.create_all()`）适合快速开发，但不擅长管理变更历史。
- SQL 脚本适合团队协作：
  - 每个人落库结果一致
  - 约束/索引明确可审查
  - 便于代码评审与回滚

因此当前约定：

- 开发联调用 SQL 脚本
- `init_db.py` 作为辅助工具保留，不作为主建表流程

### 4.2 脚本说明

在backend/db/sql目录下

#### `001_init_schema.sql`

- 创建表结构
- 定义外键、唯一约束、检查约束、索引
- 作用：确保结构一致、约束生效

#### `002_seed_demo.sql`

- 写入最小演示数据（教师/学生/画像/作业）
- 作用：接口调试时有数据可查，避免空库导致误判
